import React, { useEffect, useMemo, useState } from "react";
import confetti from "canvas-confetti";

/* =======================
   GOOGLE CALENDAR (.ICS)
======================= */
function parseICS(text) {
  const events = [];
  const lines = text.split(/\r?\n/);
  let current = null;

  for (let line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) current = {};
    if (line.startsWith("SUMMARY:")) current.title = line.replace("SUMMARY:", "");
    if (line.startsWith("DTSTART")) {
      const raw = line.split(":")[1];
      current.date = raw.slice(0, 8);
      current.time =
        raw.length > 8
          ? raw.slice(9, 13).replace(/(..)/, "$1:")
          : "";
    }
    if (line.startsWith("END:VEVENT") && current?.title) {
      events.push({
        id: uid("gcal_"),
        title: current.title,
        date: `${current.date.slice(0, 4)}-${current.date.slice(4, 6)}-${current.date.slice(6, 8)}`,
        time: current.time || "",
        category: "agenda",
      });
      current = null;
    }
  }
  return events;
}

/* =======================
   UTILS
======================= */
const uid = (p = "") => p + Math.random().toString(36).slice(2, 9);
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const load = (k, f) => JSON.parse(localStorage.getItem(k) || JSON.stringify(f));

/* =======================
   MAIN APP
======================= */
export default function App() {
  const [page, setPage] = useState("home");
  const [tasks, setTasks] = useState(load("tasks", [
    {
      id: uid(),
      label: "Nettoyer la salle de bain",
      subtasks: [
        { id: uid(), label: "Lavabo", done: false },
        { id: uid(), label: "Miroir", done: false },
        { id: uid(), label: "Douche", done: false },
        { id: uid(), label: "WC", done: false },
      ],
    },
  ]));

  const [events, setEvents] = useState(load("events", []));

  useEffect(() => save("tasks", tasks), [tasks]);
  useEffect(() => save("events", events), [events]);

  /* ===== TASKS ===== */
  const toggleSubtask = (tid, sid) => {
    setTasks(t =>
      t.map(task =>
        task.id !== tid
          ? task
          : {
              ...task,
              subtasks: task.subtasks.map(s =>
                s.id === sid ? { ...s, done: !s.done } : s
              ),
            }
      )
    );

    confetti({
      particleCount: 80,
      spread: 120,
      origin: { x: Math.random(), y: 0.6 },
      colors: ["#f472b6", "#a78bfa", "#60a5fa"],
    });
  };

  /* ===== EVENTS ===== */
  const addEvent = e => setEvents(prev => [...prev, e]);

  const importICS = file => {
    const reader = new FileReader();
    reader.onload = e => {
      const imported = parseICS(e.target.result);
      setEvents(prev => [...prev, ...imported]);
      alert(`${imported.length} Ã©vÃ©nements importÃ©s`);
    };
    reader.readAsText(file);
  };

  /* =======================
     PAGES
  ======================= */
  const Home = () => (
    <div className="space-y-4">
      <h2 className="text-xl font-bold">Accueil</h2>
      <p>Bienvenue dans ton organisateur ðŸ’œ</p>
    </div>
  );

  const Tasks = () => (
    <div className="space-y-4">
      <h2 className="text-xl font-bold">TÃ¢ches</h2>
      {tasks.map(t => (
        <div key={t.id} className="p-4 bg-white rounded-xl shadow">
          <h3 className="font-semibold mb-2">{t.label}</h3>
          {t.subtasks.map(s => (
            <label key={s.id} className="flex gap-2">
              <input
                type="checkbox"
                checked={s.done}
                onChange={() => toggleSubtask(t.id, s.id)}
              />
              <span className={s.done ? "line-through opacity-60" : ""}>
                {s.label}
              </span>
            </label>
          ))}
        </div>
      ))}
    </div>
  );

  const Agenda = () => (
    <div className="space-y-4">
      <h2 className="text-xl font-bold">Agenda</h2>

      <div className="bg-white p-3 rounded-xl shadow">
        <input
          type="file"
          accept=".ics"
          onChange={e => importICS(e.target.files[0])}
        />
      </div>

      <button
        onClick={() =>
          addEvent({
            id: uid(),
            title: "Nouveau RDV",
            date: new Date().toISOString().slice(0, 10),
            time: "",
          })
        }
        className="px-4 py-2 bg-purple-600 text-white rounded-xl"
      >
        Ajouter un RDV
      </button>

      {events.map(ev => (
        <div key={ev.id} className="p-3 bg-white rounded-xl shadow">
          <div className="font-semibold">{ev.title}</div>
          <div className="text-sm opacity-60">
            {ev.date} {ev.time}
          </div>
        </div>
      ))}
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-200 via-purple-200 to-blue-200 p-4">
      <div className="max-w-xl mx-auto">
        {page === "home" && <Home />}
        {page === "tasks" && <Tasks />}
        {page === "agenda" && <Agenda />}

        <nav className="fixed bottom-4 left-4 right-4 bg-white rounded-full shadow flex justify-around p-2">
          <button onClick={() => setPage("home")}>Accueil</button>
          <button onClick={() => setPage("tasks")}>TÃ¢ches</button>
          <button onClick={() => setPage("agenda")}>Agenda</button>
        </nav>
      </div>
    </div>
  );
}
