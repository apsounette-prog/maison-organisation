import React, { useEffect, useMemo, useState } from "react";

// Single-file React component (Tailwind CSS required)
// Usage: paste into a React app (Vite/Create React App) with Tailwind configured.
// This is a compact, production-minded prototype for a "home organization" mobile app.

export default function HomeOrgApp() {
  // --- SETTINGS ---
  const [workHours, setWorkHours] = useState({ start: "09:00", end: "17:30" });
  // user sets a date that is considered the start of a 'kids week' to compute alternating weeks
  const [kidsWeekStart, setKidsWeekStart] = useState(() => {
    const d = new Date();
    d.setDate(d.getDate() - (d.getDay() || 7)); // set to last Monday by default
    return d.toISOString().slice(0, 10);
  });

  // --- SAMPLE DATA / PERSISTENCE ---
  const [tasks, setTasks] = useState(() => {
    try {
      const raw = localStorage.getItem("homeorg_tasks");
      if (raw) return JSON.parse(raw);
    } catch (e) {}
    // default sample tasks
    return [
      {
        id: cryptoRandomId(),
        title: "Passer l'aspirateur",
        type: "chore",
        color: "bg-indigo-400",
        time: "10:00",
        days: [1, 3, 5], // Mon, Wed, Fri
        assigned: "moi",
        durationMin: 25,
        notes: "Salon + couloir",
        active: true,
      },
      {
        id: cryptoRandomId(),
        title: "G√©rer les factures",
        type: "bill",
        color: "bg-amber-400",
        dueDate: addDaysISO(3),
        amount: 120,
        paid: false,
        assigned: "moi",
      },
      {
        id: cryptoRandomId(),
        title: "Ranger chambres enfants",
        type: "chore",
        color: "bg-emerald-400",
        time: "18:00",
        days: [],
        assigned: "enfants",
        everyOtherWeek: true,
        durationMin: 20,
      },
    ];
  });

  useEffect(() => {
    localStorage.setItem("homeorg_tasks", JSON.stringify(tasks));
  }, [tasks]);

  // --- UI STATE ---
  const [selectedDate, setSelectedDate] = useState(() => new Date().toISOString().slice(0, 10));
  const [filter, setFilter] = useState({ showBills: true, showChores: true });
  const [editing, setEditing] = useState(null);

  // helpers
  function cryptoRandomId() {
    return Math.random().toString(36).slice(2, 9);
  }

  function addDaysISO(days) {
    const d = new Date();
    d.setDate(d.getDate() + days);
    return d.toISOString().slice(0, 10);
  }

  // compute whether a given date is a 'kids week' based on parity from kidsWeekStart
  function isKidsWeek(dateISO) {
    const a = new Date(kidsWeekStart);
    a.setHours(0, 0, 0, 0);
    const b = new Date(dateISO);
    b.setHours(0, 0, 0, 0);
    const diffDays = Math.floor((b - a) / (1000 * 60 * 60 * 24));
    if (isNaN(diffDays)) return false;
    const weeks = Math.floor(diffDays / 7);
    return weeks % 2 === 0; // same parity as start date means kids week
  }

  // Week view: get 7 days starting Monday containing selectedDate
  const weekDates = useMemo(() => {
    const d = new Date(selectedDate + "T00:00");
    const day = d.getDay();
    const monday = new Date(d);
    monday.setDate(d.getDate() - ((day + 6) % 7));
    const arr = [];
    for (let i = 0; i < 7; i++) {
      const dd = new Date(monday);
      dd.setDate(monday.getDate() + i);
      arr.push(dd.toISOString().slice(0, 10));
    }
    return arr;
  }, [selectedDate]);

  // tasks for a specific date
  function tasksForDate(dateISO) {
    const weekday = new Date(dateISO).getDay(); // 0 Sun .. 6 Sat
    const weekdayISO = weekday === 0 ? 7 : weekday; // 1 Mon .. 7 Sun
    return tasks.filter((t) => {
      if (!t.active) return false;
      if (t.type === "bill") return true; // bills show under their due date UI separately

      // everyOtherWeek logic: if set, show only when date is kids week OR not depending on assigned
      if (t.everyOtherWeek) {
        // t.assigned may be 'enfants' meaning do when kids present
        const kidsPresent = isKidsWeek(dateISO);
        if (t.assigned === "enfants" && !kidsPresent) return false;
        if (t.assigned === "moi" && kidsPresent) return false; // example: some tasks only when kids absent
      }

      if (t.days && t.days.length) {
        return t.days.includes(weekdayISO);
      }
      // if no days defined but time defined, show on selected day(s) ‚Äî we treat as flexible if no days
      return true;
    });
  }

  // CRUD helpers
  function upsertTask(task) {
    if (!task.id) task.id = cryptoRandomId();
    setTasks((prev) => {
      const idx = prev.findIndex((p) => p.id === task.id);
      if (idx >= 0) {
        const copy = [...prev];
        copy[idx] = task;
        return copy;
      }
      return [task, ...prev];
    });
    setEditing(null);
  }

  function removeTask(id) {
    setTasks((prev) => prev.filter((t) => t.id !== id));
  }

  function togglePaid(id) {
    setTasks((prev) => prev.map((t) => (t.id === id ? { ...t, paid: !t.paid } : t)));
  }

  // export/import
  function exportJSON() {
    const blob = new Blob([JSON.stringify({ tasks, kidsWeekStart, workHours }, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "homeorg-export.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJSON(e) {
    const f = e.target.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (data.tasks) setTasks(data.tasks);
        if (data.kidsWeekStart) setKidsWeekStart(data.kidsWeekStart);
        if (data.workHours) setWorkHours(data.workHours);
      } catch (err) {
        alert("Fichier invalide");
      }
    };
    reader.readAsText(f);
  }

  // --- RENDER ---
  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <div className="max-w-xl mx-auto bg-white rounded-2xl shadow p-4">
        <header className="flex items-center justify-between mb-3">
          <h1 className="text-xl font-semibold">Organisation Maison</h1>
          <div className="text-sm text-gray-600">Semaine: {weekDates[0]} ‚Üí {weekDates[6]}</div>
        </header>

        {/* Controls */}
        <div className="flex gap-2 mb-4">
          <input
            type="date"
            value={selectedDate}
            onChange={(e) => setSelectedDate(e.target.value)}
            className="p-2 border rounded w-1/2"
          />
          <button
            className="p-2 bg-indigo-600 text-white rounded flex-1"
            onClick={() => {
              // jump to next week
              const d = new Date(selectedDate);
              d.setDate(d.getDate() + 7);
              setSelectedDate(d.toISOString().slice(0, 10));
            }}
          >
            Semaine suivante
          </button>
        </div>

        {/* Week overview */}
        <div className="grid grid-cols-7 gap-2 mb-4">
          {weekDates.map((d) => (
            <div key={d} className="p-2 rounded-lg border text-xs">
              <div className="flex items-center justify-between mb-1">
                <div className="font-medium">{formatShortDate(d)}</div>
                <div className="text-[10px] px-1 py-0.5 rounded text-white bg-gray-400">{isKidsWeek(d) ? "Enfants" : "Sans"}</div>
              </div>
              <div className="space-y-1">
                {tasksForDate(d)
                  .filter((t) => t.type !== "bill")
                  .slice(0, 3)
                  .map((t) => (
                    <div key={t.id} className={`text-[12px] p-1 rounded ${t.color} text-white`}>
                      <div className="font-medium">{t.title}</div>
                      <div className="text-[11px]">{t.time || (t.durationMin ? `${t.durationMin} min` : "Flexible")}</div>
                    </div>
                  ))}
              </div>
            </div>
          ))}
        </div>

        {/* Bills quick list */}
        <section className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-sm font-semibold">Factures & Paiements</h2>
            <div className="text-xs text-gray-500">(toggle pay√©)</div>
          </div>
          <div className="space-y-2">
            {tasks
              .filter((t) => t.type === "bill")
              .slice(0, 5)
              .map((b) => (
                <div key={b.id} className="flex items-center justify-between p-2 border rounded">
                  <div>
                    <div className="font-medium">{b.title}</div>
                    <div className="text-xs text-gray-500">Due: {b.dueDate} ‚Äî {b.amount ? `${b.amount} ‚Ç¨` : "‚Äî"}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button className={`px-3 py-1 rounded ${b.paid ? "bg-green-200" : "bg-red-200"}`} onClick={() => togglePaid(b.id)}>
                      {b.paid ? "Pay√©e" : "√Ä payer"}
                    </button>
                    <button className="text-sm text-gray-500" onClick={() => setEditing(b)}>
                      ‚úé
                    </button>
                  </div>
                </div>
              ))}
          </div>
        </section>

        {/* Task list + add button */}
        <section>
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-sm font-semibold">T√¢ches et routines</h2>
            <div className="flex gap-2">
              <button
                className="px-3 py-1 border rounded text-sm"
                onClick={() => {
                  setEditing({
                    id: null,
                    title: "",
                    type: "chore",
                    color: "bg-indigo-400",
                    time: "",
                    days: [],
                    assigned: "moi",
                    everyOtherWeek: false,
                    durationMin: 15,
                    active: true,
                  });
                }}
              >
                + Ajouter
              </button>
              <button className="px-3 py-1 border rounded text-sm" onClick={exportJSON}>Exporter</button>
              <label className="px-3 py-1 border rounded text-sm cursor-pointer">
                Importer
                <input type="file" accept="application/json" onChange={importJSON} className="hidden" />
              </label>
            </div>
          </div>

          <div className="space-y-2 max-h-64 overflow-auto">
            {tasks.map((t) => (
              <div key={t.id} className="p-2 border rounded flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-3 h-8 rounded ${t.color}`} />
                  <div>
                    <div className="font-medium">{t.title}</div>
                    <div className="text-xs text-gray-500">{t.type} ‚Äî {t.assigned}{t.everyOtherWeek ? " ‚Äî Une semaine sur deux" : ""}</div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button className="text-xs text-gray-500" onClick={() => setEditing(t)}>‚úé</button>
                  <button className="text-xs text-red-500" onClick={() => removeTask(t.id)}>üóë</button>
                </div>
              </div>
            ))}
          </div>
        </section>

        {/* Editing modal (inline) */}
        {editing && (
          <div className="fixed inset-0 bg-black/30 flex items-end md:items-center justify-center p-4">
            <div className="bg-white rounded-xl w-full max-w-md p-4">
              <h3 className="font-semibold mb-2">{editing.id ? "Modifier" : "Nouvelle t√¢che"}</h3>
              <div className="space-y-2">
                <input className="w-full p-2 border rounded" placeholder="Titre" value={editing.title} onChange={(e) => setEditing({ ...editing, title: e.target.value })} />
                <div className="flex gap-2">
                  <select value={editing.type} onChange={(e) => setEditing({ ...editing, type: e.target.value })} className="p-2 border rounded flex-1">
                    <option value="chore">M√©nage / T√¢che</option>
                    <option value="bill">Facture</option>
                    <option value="other">Autre</option>
                  </select>
                  <input type="time" value={editing.time || ""} onChange={(e) => setEditing({ ...editing, time: e.target.value })} className="p-2 border rounded" />
                </div>

                <div className="flex gap-2 text-sm">
                  <label className="flex-1">
                    <div className="text-xs text-gray-600">Assign√©e √†</div>
                    <select value={editing.assigned} onChange={(e) => setEditing({ ...editing, assigned: e.target.value })} className="w-full p-2 border rounded">
                      <option value="moi">Moi</option>
                      <option value="enfants">Enfants</option>
                      <option value="tous">Tous</option>
                    </select>
                  </label>
                  <label className="flex-1">
                    <div className="text-xs text-gray-600">Dur√©e (min)</div>
                    <input type="number" value={editing.durationMin || 0} onChange={(e) => setEditing({ ...editing, durationMin: Number(e.target.value) })} className="w-full p-2 border rounded" />
                  </label>
                </div>

                <div>
                  <div className="text-xs text-gray-600 mb-1">Jours (cochez pour r√©p√©tition hebdo)</div>
                  <div className="flex gap-1 text-xs">
                    {['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].map((label, i) => {
                      const val = i + 1;
                      const checked = (editing.days || []).includes(val);
                      return (
                        <button key={label} onClick={() => {
                          const days = new Set(editing.days || []);
                          if (days.has(val)) days.delete(val); else days.add(val);
                          setEditing({ ...editing, days: Array.from(days).sort() });
                        }} className={`p-1 rounded text-[12px] border ${checked ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700'}`}>{label}</button>
                      );
                    })}
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" checked={!!editing.everyOtherWeek} onChange={(e) => setEditing({ ...editing, everyOtherWeek: e.target.checked })} />
                    Une semaine sur deux
                  </label>
                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" checked={!!editing.active} onChange={(e) => setEditing({ ...editing, active: e.target.checked })} />
                    Active
                  </label>
                </div>

                {editing.type === 'bill' && (
                  <div className="flex gap-2">
                    <input type="date" value={editing.dueDate || addDaysISO(0)} onChange={(e) => setEditing({ ...editing, dueDate: e.target.value })} className="p-2 border rounded flex-1" />
                    <input type="number" placeholder="‚Ç¨" value={editing.amount || 0} onChange={(e) => setEditing({ ...editing, amount: Number(e.target.value) })} className="p-2 border rounded w-24" />
                  </div>
                )}

                <div className="flex justify-end gap-2 mt-2">
                  <button className="px-3 py-1" onClick={() => setEditing(null)}>Annuler</button>
                  <button className="px-3 py-1 bg-indigo-600 text-white rounded" onClick={() => upsertTask(editing)}>Enregistrer</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Settings panel */}
        <div className="mt-4 border-t pt-3 text-sm text-gray-600">
          <h3 className="font-semibold">Param√®tres</h3>
          <div className="mt-2 grid grid-cols-2 gap-2">
            <label className="text-xs">
              Heure d√©but travail
              <input type="time" value={workHours.start} onChange={(e) => setWorkHours({ ...workHours, start: e.target.value })} className="w-full p-1 border rounded mt-1" />
            </label>
            <label className="text-xs">
              Heure fin travail
              <input type="time" value={workHours.end} onChange={(e) => setWorkHours({ ...workHours, end: e.target.value })} className="w-full p-1 border rounded mt-1" />
            </label>
          </div>

          <div className="mt-2">
            <div className="text-xs">Date de r√©f√©rence pour alternance enfants</div>
            <input type="date" value={kidsWeekStart} onChange={(e) => setKidsWeekStart(e.target.value)} className="p-2 border rounded mt-1 w-full" />
            <div className="text-xs text-gray-500 mt-1">Choisissez une date qui correspond au d√©but d'une semaine o√π vous avez les enfants ‚Äî l'application d√©duira la semaine sur deux ensuite.</div>
          </div>
        </div>

      </div>
    </div>
  );
}

// --- Small helpers used in UI ---
function formatShortDate(iso) {
  const d = new Date(iso + "T00:00");
  const dayNames = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  return `${dayNames[d.getDay()]} ${d.toLocaleDateString(undefined, { day: '2-digit', month: 'short' })}`;
}

function addDaysISO(days) {
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0, 10);
}
